<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AP - Lista de Confirmados</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
html, body {
    margin: 0; padding: 0;
    background: #f7f7f7;
    font-family: Arial;
}
body.dark { background:#222; color:#eee; }
.container { padding:20px; }
input, button {
    padding: 10px;
    margin-top: 10px;
    width: 100%;
    font-size: 16px;
}
table { width:100%; margin-top:20px; border-collapse:collapse; }
td, th {
    border:1px solid #ccc;
    padding:12px;
}
.present {
    background:#c8ffc8;
    font-weight:bold;
}
body.dark .present { background:#2f4f2f; }

/* LOGIN */
#loginModal{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:black;color:white;display:flex;
    flex-direction:column;justify-content:center;
    align-items:center;z-index:9999;
}

</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginModal">
    <h2>Digite a senha</h2>
    <input type="password" id="senhaInput" placeholder="Senha" style="max-width:300px;">
    <button onclick="verificarSenha()" style="max-width:180px;">Entrar</button>
</div>

<div class="container">
<h1>AP - Lista de Confirmados</h1>

<button id="darkBtn" onclick="toggleDark()">Modo Escuro</button>

<h3>Adicionar nome</h3>
<input type="text" id="nome">
<button onclick="addPessoa()">Adicionar</button>

<h3>Importar CSV/Excel</h3>
<input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
<button onclick="importarArquivo()">Importar</button>

<h3>Buscar</h3>
<input type="text" id="busca" oninput="filtrarTabela()" placeholder="Digite um nome...">

<div id="contador" style="margin-top:20px; font-weight:bold;"></div>

<table>
<thead>
<tr><th>Nome</th><th>Status</th><th>AÃ§Ã£o</th></tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ==========================
   ðŸ”¥ FIREBASE CONFIG
=========================== */
const firebaseConfig = {
  apiKey: "AIzaSyCW7fYPJcXkqVXYXyLUOkU-acnVyD9a6AI",
  authDomain: "ap-listadeconfirmados.firebaseapp.com",
  databaseURL: "https://ap-listadeconfirmados-default-rtdb.firebaseio.com",
  projectId: "ap-listadeconfirmados",
  storageBucket: "ap-listadeconfirmados.firebasestorage.app",
  messagingSenderId: "719499907860",
  appId: "1:719499907860:web:e5a522fce3c19f9b012801"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* LOGIN */
const SENHA = "1234@@@";

function verificarSenha(){
    const s = document.getElementById("senhaInput").value;
    if(s === SENHA){
        localStorage.setItem("logado","1");
        document.getElementById("loginModal").style.display="none";
    } else {
        alert("Senha incorreta");
    }
}

if(localStorage.getItem("logado")==="1"){
    document.getElementById("loginModal").style.display="none";
}

/* LISTA EM TEMPO REAL */
let pessoas = [];
let nextId = 1;

db.ref("pessoas").on("value", snap => {
    const dados = snap.val();
    pessoas = dados ? Object.values(dados) : [];
    nextId = pessoas.length ? Math.max(...pessoas.map(x=>x.id)) + 1 : 1;
    pessoas.sort((a,b)=> a.nome.localeCompare(b.nome));
    atualizarTabela();
});

function atualizarContador(){
    const total = pessoas.length;
    const presentes = pessoas.filter(p => p.presente).length;
    const ausentes = total - presentes;
    document.getElementById("contador").innerText =
        `Presentes: ${presentes} | Ausentes: ${ausentes} | Total: ${total}`;
}

function atualizarTabela(lista = null){
    const tbody = document.getElementById("lista");
    tbody.innerHTML = "";

    (lista || pessoas).forEach(p => {
        const tr = document.createElement("tr");
        if(p.presente) tr.classList.add("present");

        tr.innerHTML = `
            <td>${p.nome}</td>
            <td>${p.presente ? "Presente" : "Ausente"}</td>
            <td><button onclick="confirmarPresenca(${p.id})" ${p.presente ? "disabled":""}>Confirmar</button></td>
        `;
        tbody.appendChild(tr);
    });

    atualizarContador();
}

/* ADICIONAR */
function addPessoa(){
    const nome = document.getElementById("nome").value.trim();
    if(!nome) return alert("Digite um nome");

    const pessoa = { id: nextId++, nome, presente:false };
    db.ref("pessoas/" + pessoa.id).set(pessoa);

    document.getElementById("nome").value = "";
}

/* CONFIRMAR */
function confirmarPresenca(id){
    db.ref("pessoas/" + id + "/presente").set(true);
}

/* FILTRAR */
function filtrarTabela(){
    const termo = document.getElementById("busca").value.toLowerCase();
    if(!termo) return atualizarTabela();
    const f = pessoas.filter(p => p.nome.toLowerCase().includes(termo));
    atualizarTabela(f);
}

/* IMPORTAR */
function importarArquivo(){
    const arq = document.getElementById("fileInput").files[0];
    if(!arq) return alert("Escolha um arquivo");

    const reader = new FileReader();
    reader.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const sheet = wb.SheetNames[0];
        const dados = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {header:1});

        db.ref("pessoas").set(null);
        nextId = 1;

        let count = 0;
        dados.forEach(l => {
            if(!l[0]) return;
            const nome = String(l[0]).trim();
            if(!nome) return;

            const pessoa = { id: nextId++, nome, presente:false };
            db.ref("pessoas/" + pessoa.id).set(pessoa);
            count++;
        });

        alert(count+" nomes importados!");
    };
    reader.readAsArrayBuffer(arq);
}

/* DARK MODE */
function toggleDark(){
    document.body.classList.toggle("dark");
}

/* PWA */
if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
